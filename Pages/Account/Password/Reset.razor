@page "/account/password/reset"
@using System.ComponentModel.DataAnnotations
@using TeamCashCenter.Services
@using Notification = TeamCashCenter.Services.Notification
@inject Microsoft.AspNetCore.Identity.UserManager<User> UserManager
@inject NotificationService NotificationService
@inject NavigationManager Navigation

<div class="d-flex justify-content-center">
    <div class="card col-12 col-md-6">
        <div class="card-body">
            <h3 class="card-title">Reset Password</h3>

            <EditForm Model="model" OnValidSubmit="HandleReset">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="model.Email" />
                    <ValidationMessage For="() => model.Email" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Reset Token</label>
                    <InputText class="form-control" @bind-Value="model.Token" />
                    <ValidationMessage For="() => model.Token" />
                </div>

                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <InputText class="form-control" type="password" @bind-Value="model.NewPassword" />
                    <ValidationMessage For="() => model.NewPassword" />
                </div>

                <button class="btn btn-primary" type="submit" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    Reset Password
                </button>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private ResetModel model = new ResetModel();
    private bool isSubmitting = false;

    public class ResetModel
    {
        [Required, EmailAddress]
        public string? Email { get; set; }

        [Required]
        public string? Token { get; set; }

        [Required, MinLength(6)]
        public string? NewPassword { get; set; }
    }

    private async Task HandleReset()
    {
        try
        {
            isSubmitting = true;
            StateHasChanged();

            var user = await UserManager.FindByEmailAsync(model.Email ?? string.Empty);
            if (user == null)
            {
                NotificationService.Set(new Notification { Message = "Invalid request.", Type = "error" });
                return;
            }

            var result = await UserManager.ResetPasswordAsync(user, model.Token ?? string.Empty, model.NewPassword ?? string.Empty);
            if (result.Succeeded)
            {
                NotificationService.Set(new Notification { Message = "Password has been reset successfully.", Type = "success" });
            }
            else
            {
                var msg = string.Join("; ", result.Errors.Select(e => e.Description));
                NotificationService.Set(new Notification { Message = $"Failed to reset password: {msg}", Type = "error" });
            }
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var qp = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (qp.TryGetValue("email", out var e)) model.Email = e.ToString();
        if (qp.TryGetValue("token", out var t)) model.Token = System.Net.WebUtility.UrlDecode(t.ToString());
    }
}
