@page "/payments/edit/{Id:guid?}"
@using Microsoft.AspNetCore.Identity
@using TeamCashCenter.Data
@using TeamCashCenter.Services.Contracts
@attribute [Authorize(Policy = "CanViewTransactions")]
@inject NavigationManager Nav
@inject UserManager<User> UserManager
@inject CashCenterContext Db
@inject IPaymentService paymentService

<div class="card">
    <div class="card-body">
        <h2 class="card-title">@(payment.Id == Guid.Empty ? "Neue geplante Zahlung" : "Geplante Zahlung bearbeiten")</h2>

        <EditForm Model="payment" OnValidSubmit="Save">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row align-items-start">
                <div class="mb-3 col-6">
                    <label class="form-label">Spieler</label>
                    <InputSelect class="form-select" @bind-Value="payment.UserId">
                        @*<option value="">-- auswählen --</option>*@
                        @foreach (var p in users) { <option value="@p.Id">@p.FirstName @p.LastName</option> }
                    </InputSelect>
                    <ValidationMessage For="() => payment.UserId" />
                </div>
                
                <div class="mb-3 col-6">
                    <label class="form-label">Betrag</label>
                    <CurrencyInput TValue="decimal" @bind-Value="payment.Amount" Locale="de-DE" Placeholder="Betrag" ShowCurrencySymbol="true" />
                    <ValidationMessage For="() => payment.Amount" />
                </div>
            </div>
            
            
            <div class="mb-3">
                <label class="form-label">Beschreibung</label>
                <InputText class="form-control" @bind-Value="payment.Description" />
                <ValidationMessage For="() => payment.Description" />
            </div>
            <div class="mb-3">
                <label class="form-label">Art</label>
                <InputSelect class="form-select" @bind-Value="payment.TransactionTypeId">
                    <option value="">-- auswählen --</option>
                    @foreach (var t in transactionTypes)
                    {
                        <option value="@t.Id">@t.Name</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">Fälligkeitsdatum</label>
                <InputDate class="form-control" @bind-Value="payment.DueDate" />
                <ValidationMessage For="() => payment.DueDate" />
            </div>
            
            <div class="form-check mb-3">
                <InputCheckbox class="form-check-input" @bind-Value="payment.IsPaid" />
                <label class="form-check-label">Bezahlt</label>
            </div>

            <button class="btn btn-primary" type="submit">Speichern</button>
            <a class="btn btn-secondary ms-2" href="/payments">Abbrechen</a>
        </EditForm>
    </div>
</div>

@code {
    [Parameter]
    public int? Id { get; set; }

    private Payment payment = new() { DueDate = DateTime.Today };
    private IList<User> users = [];
    private List<TransactionType> transactionTypes = [];
    
    protected override async Task OnInitializedAsync()
    {
        users = await UserManager.Users.ToListAsync();
        users.Insert(0, new User { Id = Guid.Empty, FirstName = "--- alle ---"});

        transactionTypes = await Db.TransactionTypes.Where(t => !t.IsRegularFee).ToListAsync();
        
        if (Id.HasValue)
        {
            var existing = await Db.Payments.FindAsync(Id.Value);
            if (existing != null) payment = existing;
        }
    }

    private async Task Save()
    {
        if (payment.UserId != null && payment.UserId != Guid.Empty)
        {
            await SavePayment(payment);
            return;
        }
        
        var allUsers = await UserManager.Users.ToListAsync();
        var payments = payment.CreateNewForUsers(allUsers.Select(u => u.Id));
        foreach (var p in payments)
        {
            await SavePayment(p);
        }
    }

    
    private async Task SavePayment(Payment pm)
    {
        await paymentService.UpsertAsync(pm);
        Nav.NavigateTo("/payments");
    }
}
