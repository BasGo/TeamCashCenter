@page "/admin/assignments"
@using Microsoft.AspNetCore.Identity
@using System.Linq
@using TeamCashCenter.Data
@attribute [Authorize(Roles = "Admin")]
@inject UserManager<User> UserManager
@inject RoleManager<Role> RoleManager
@inject Services.NotificationService NotificationService
@inject CashCenterContext Db

<h2>Rollenzuweisungen</h2>

<div class="mb-3 d-flex">
    <input class="form-control me-2" placeholder="Benutzer mit Hilfe ihrer E-Mail-Adresse suchen" @bind="userSearch" />
    <button class="btn btn-outline-secondary" @onclick="() => userSearch = string.Empty">Leeren</button>
</div>
@if (users is null || roles is null)
{
    <p>Lade ...</p>
}
else
{
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>User</th>
                @foreach (var r in roles) { <th>@r.Name</th> }
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in users.Where(u => string.IsNullOrEmpty(userSearch) || (u.Email ?? string.Empty).Contains(userSearch, StringComparison.OrdinalIgnoreCase)))
            {
                <tr>
                    <td>@u.Email</td>
                    @foreach (var rn in roles.Select(r => r.Name ?? string.Empty))
                    {
                        var has = rn.Length > 0 && userRoles.TryGetValue(u.Id, out var set) && set.Contains(rn);
                        <td>
                            <input type="checkbox" checked="@has" disabled="@savingUsers.Contains(u.Id)" @onchange="e => ToggleRole(u.Id, rn, e)" />
                        </td>
                    }
                    <td>
                        <button class="btn btn-sm btn-primary" @onclick="() => SaveUserRoles(u.Id)" disabled="@savingUsers.Contains(u.Id)">@(savingUsers.Contains(u.Id) ? "Speichere ..." : "Speichern")</button>
                        @if (statusMessages.TryGetValue(u.Id, out var msg) && !string.IsNullOrEmpty(msg)) { <div class="form-text text-success mt-1">@msg</div> }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Role>? roles;
    private List<User>? users;
    private readonly Dictionary<Guid, HashSet<string>> userRoles = new();

    private string userSearch = string.Empty;

    private readonly HashSet<Guid> savingUsers = new();
    private readonly Dictionary<Guid, string> statusMessages = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        roles = await RoleManager.Roles.OrderBy(r => r.Name).ToListAsync();
        
        // Load users directly from the DbContext to avoid any unexpected filtering from UserManager
        users = await Db.Users.OrderBy(u => u.Email).ToListAsync();

        userRoles.Clear();
        foreach (var u in users)
        {
            var assigned = new HashSet<string>(await UserManager.GetRolesAsync(u));
            userRoles[u.Id] = assigned;
        }
    }
    
    private void ToggleRole(Guid userId, string roleName, ChangeEventArgs e)
    {
        if (!userRoles.TryGetValue(userId, out var set)) userRoles[userId] = set = [];
        var isChecked = e.Value is bool b && b;
        if (isChecked) set.Add(roleName); else set.Remove(roleName);
    }

    private async Task SaveUserRoles(Guid userId)
    {
        if (!savingUsers.Add(userId)) return;
        statusMessages[userId] = string.Empty;
        try
        {
            var user = await UserManager.FindByIdAsync(userId.ToString());
            if (user == null) return;
            var current = new HashSet<string>(await UserManager.GetRolesAsync(user));
            if (!userRoles.TryGetValue(userId, out var desired)) desired = [];

            var toAdd = desired.Except(current).ToList();
            var toRemove = current.Except(desired).ToList();

            if (toAdd.Any()) await UserManager.AddToRolesAsync(user, toAdd);
            if (toRemove.Any()) await UserManager.RemoveFromRolesAsync(user, toRemove);

            // reload row state
            userRoles[userId] = new HashSet<string>(await UserManager.GetRolesAsync(user));
            statusMessages[userId] = "gespeichert";
        }
        finally
        {
            savingUsers.Remove(userId);
        }
    }
}
